#---------------------------------------------Hmms and HMMMER-----------------------------------------------------------------------------#
#Extracting a subset of Foam collection on nitrogen fixation and preparing for running HMMER
#!/bin/bash
##
#SBATCH -p test
#SBATCH --mem=50G
#SBATCH --time=5-18:0:0
#SBATCH -n 5
#SBATCH -o /share/tearlab/Maga/Jill/CDRF_MetaGenome/Foam_2018/Error_Out_Files/Foam_Nitro.press.out
#SBATCH -e /share/tearlab/Maga/Jill/CDRF_MetaGenome/Foam_2018/Error_Out_Files/Foam_Nitro.press.err
module load hmmer/3.1b2

cd /share/tearlab/Maga/Jill/CDRF_MetaGenome/Foam_2018/
#Make list of names to extract, sort and return unique names
#In termimal: grep -f Nitro_KOs.txt FOAM-hmm_rel1a.hmm | sort -u > Nitro_KOs_Full.txt
#remove "NAME  " at the beginning of the line
#time hmmfetch -o Nitro_Foam.hmm -f FOAM-hmm_rel1a.hmm Nitro_KOs_Full.txt
time hmmpress Nitro_Foam.hmm

#Running HMMER
#!/bin/bash

NEW[0]=1-10_S26
NEW[1]=1-12_S27
NEW[2]=1-1_S25
NEW[3]=5-11_S29
NEW[4]=5-14_S30
NEW[5]=5-6_S28
NEW[6]=6-1_S31
NEW[7]=6-5_S32
NEW[8]=6-7_S33
NEW[9]=8-10_S36
NEW[10]=8-8_S34
NEW[11]=8-9_S35

for i in "${!NEW[@]}"
do
	echo ${NEW[$i]}
	echo "#!/bin/bash" > NFM.${NEW[$i]}.sh
	echo "##" >> NFM.${NEW[$i]}.sh
	echo "#SBATCH -n 30" >> NFM.${NEW[$i]}.sh
	echo "#SBATCH --mem=40G" >> NFM.${NEW[$i]}.sh
	echo "#SBATCH -p assembly" >> NFM.${NEW[$i]}.sh
	echo "#SBATCH --time=9-0:0:0" >> NFM.${NEW[$i]}.sh
	echo "#SBATCH -o /share/tearlab/Maga/Jill/CDRF_MetaGenome/Foam_2018/Error_Out_Files/${NEW[$i]}.foam.Merged.out" >> NFM.${NEW[$i]}.sh
	echo "#SBATCH -e /share/tearlab/Maga/Jill/CDRF_MetaGenome/Foam_2018/Error_Out_Files/${NEW[$i]}.foam.Merged.err" >> NFM.${NEW[$i]}.sh
	echo "module load hmmer/3.1b2" >> NFM.${NEW[$i]}.sh
	echo "cd /share/tearlab/Maga/Jill/CDRF_MetaGenome/Foam_2018/" >> NFM.${NEW[$i]}.sh
	echo "time hmmscan --noali --cpu 30 -E 0.00001 --tblout /share/tearlab/Maga/Jill/CDRF_MetaGenome/Foam_2018/Merged_Results/${NEW[$i]}.Foam.tblout Nitro_Foam.hmm /share/tearlab/Maga/Jill/CDRF_MetaGenome/Protein_2018/Merged_Results/${NEW[$i]}.6frame.faa" >> NFM.${NEW[$i]}.sh
	echo "echo "Done Hmmscan on Merged Reads"" >> NFM.${NEW[$i]}.sh
	sbatch NFM.${NEW[$i]}.sh
done
